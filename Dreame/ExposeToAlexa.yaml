blueprint:
  name: Espone script per Alexa (Dreame + Vacuum Map, per stanza) — Lite
  description: |
    Crea uno script eseguibile da Alexa per avviare la pulizia di una stanza del robot Dreame.
    Usa solo i parametri supportati da dreame_vacuum.vacuum_clean_segment (niente cleaning_mode).

    Requisiti:
    - Integrazione Dreame funzionante.
    - Vacuum Map card (tasshack) che popola un input_select con opzioni tipo "Nome (ID)".
    - Un input_select (già popolato dal blueprint 1) con le stanze in formato "Nome (ID)".

    Alexa: dire "avvia <nome script>" oppure "apri <nome script>".

  domain: script

  input:
    vacuum_entity:
      name: Entità robot Dreame
      selector:
        entity:
          domain: vacuum

    room_helper:
      name: Helper stanze (input_select)
      description: Seleziona l'input_select già popolato con le stanze "Nome (ID)".
      selector:
        entity:
          domain: input_select

    cleaning_preset:
      name: Tipo di pulizia
      selector:
        select:
          options:
            - Sola Aspirazione
            - Solo Lavaggio
            - Pulizia (Clean Genius)
            - Pulizia profonda (Clean Genius)
          multiple: false
          mode: dropdown

mode: restart
icon: mdi:robot-vacuum

sequence:
  - variables:
      _helper: !input room_helper
      _vac: !input vacuum_entity
      _preset: !input cleaning_preset

      room_label: "{{ states(_helper) | string }}"
      room_id: "{{ iif('(' in room_label and ')' in room_label, room_label.split('(')[-1].split(')')[0] | int, -1) }}"
      preset_lc: "{{ (_preset or 'Pulizia') | lower }}"

      # Default semplici per i preset, senza usare cleaning_mode
      suction_out: >
        {{ 3 if preset_lc == 'aspirazione' else omit }}
      water_out: >
        {{ 2 if preset_lc == 'lavaggio' else omit }}
      passes_out: >
        {{ 2 if preset_lc == 'pulizia profonda' else omit }}

  - condition: template
    value_template: "{{ room_id | int(-1) >= 0 }}"

  - service: dreame_vacuum.vacuum_clean_segment
    target:
      entity_id: "{{ _vac }}"
    data:
      segments:
        - "{{ room_id | int }}"
      suction_level: "{{ suction_out }}"
      water_volume: "{{ water_out }}"
      cleaning_times: "{{ passes_out }}"
