blueprint:
  name: "üéôÔ∏è Alexa: Script Pulizia Stanze Dreame"
  description: |
    ## üöÄ Cosa fa questo blueprint
    Crea uno **script personalizzato** per comandare il tuo robot Dreame con la voce tramite Alexa!
    
    ‚úÖ **Pulizia mirata** di una stanza specifica  
    ‚úÖ **4 modalit√†** di pulizia disponibili  
    ‚úÖ **Pronto per Alexa** - nessuna configurazione aggiuntiva  
    ‚úÖ **Facilmente clonabile** per multiple stanze  
    
    ## üè† Modalit√† di Pulizia Disponibili
    
    | Modalit√† | Descrizione | Tecnologia |
    |----------|-------------|------------|
    | üßπ **Aspirazione** | Solo aspirazione | Cleaning Mode |
    | üíß **Lavaggio** | Solo lavaggio | Cleaning Mode |
    | ‚ú® **Pulizia** | Aspirazione + Lavaggio | CleanGenius |
    | üî• **Pulizia Profonda** | Aspirazione + Lavaggio Intensivo | CleanGenius Deep |
    
    ## üìã Prerequisiti
    1. ‚úÖ Robot Dreame configurato in Home Assistant
    2. ‚úÖ Helper delle stanze creato (usa il blueprint "üè† Creazione Helper Stanze")
    3. ‚úÖ Alexa configurata (Nabu Casa, Lambda, o Matter)
    
    ## üéØ Come Usarlo
    
    ### Passo 1: Configura lo Script
    1. **Seleziona** il tuo robot e le entit√† necessarie
    2. **Inserisci** l'ID della stanza (trovalo nell'helper delle stanze)
    3. **Scegli** la modalit√† di pulizia
    4. **Salva** lo script con un nome descrittivo
    
    ### Passo 2: Esponi ad Alexa
    - **Nabu Casa**: Lo script apparir√† automaticamente
    - **Matter**: Aggiungi il label "matter" allo script
    - **Lambda**: Configura nel tuo setup AWS
    
    ### Passo 3: Comandi Vocali
    **"Alexa, avvia [nome dello script]"**  
    **"Alexa, apri [nome dello script]"**
    
    ## üí° Esempi Pratici
    
    ### Scenario: Pulizia del Bagno
    1. **Crea** script: "Aspirazione Bagno" (ID stanza: 5, modalit√†: Aspirazione)
    2. **Clona** script: "Pulizia Bagno" (stesso ID, modalit√†: Pulizia)
    3. **Comandi**: 
       - "Alexa, avvia aspirazione bagno" 
       - "Alexa, avvia pulizia bagno"
    
    ### Scenario: Cucina Completa
    - Script 1: "Pulizia Cucina" ‚Üí "Alexa, avvia pulizia cucina"
    - Script 2: "Pulizia Profonda Cucina" ‚Üí "Alexa, avvia pulizia profonda cucina"
    
    ## ‚öôÔ∏è Note Tecniche
    - **CleanGenius**: Modalit√† avanzata che combina aspirazione e lavaggio
    - **Cleaning Mode**: Modalit√† base per aspirazione o lavaggio separati
    - **Timeout**: 10 secondi per il cambio delle impostazioni
    - **Validazione**: Controlla automaticamente che l'ID stanza sia valido
    
  domain: script
  source_url: https://raw.githubusercontent.com/Magnum9O/HA_BluePrints/main/Dreame/ITA/2_EsponiAdAlexa.yaml

  input:
    vacuum_entity:
      name: "ü§ñ Robot Dreame"
      description: |
        Seleziona il tuo aspirapolvere robot Dreame.
        
        üí° **Esempio**: `vacuum.dreame_l10s_ultra` o `vacuum.xiaomi_vacuum_cleaner`
      selector:
        entity:
          domain: vacuum

    cleangenius_select:
      name: "‚ú® Entit√† CleanGenius"
      description: |
        Seleziona l'entit√† che controlla la modalit√† **CleanGenius** del tuo robot.
        
        üí° **Come trovarla**: Cerca tra le entit√† `select` del tuo robot, di solito ha un nome come:
        - `select.nome_robot_cleangenius`
        - `select.dreame_cleangenius`
      selector:
        entity:
          domain: select

    cleaning_mode_select:
      name: "üîß Entit√† Cleaning Mode"
      description: |
        Seleziona l'entit√† che controlla il **Cleaning Mode** (aspirazione/lavaggio separati).
        
        üí° **Come trovarla**: Cerca tra le entit√† `select` del tuo robot, di solito:
        - `select.nome_robot_cleaning_mode`
        - `select.dreame_cleaning_mode`
      selector:
        entity:
          domain: select

    room_id:
      name: "üè† ID Stanza"
      description: |
        **Inserisci l'ID numerico** della stanza che vuoi pulire.
        
        üîç **Come trovarlo**: 
        1. Usa il blueprint "üè† Creazione Helper Stanze"
        2. Controlla l'helper creato per vedere "Nome Stanza (**ID**)"
        3. Inserisci solo il numero tra parentesi
        
        üìù **Esempio**: Se vedi "Cucina (3)", inserisci **3**
      selector:
        number:
          min: 0
          max: 999
          mode: box
      default: 0

    cleaning_preset:
      name: "üéØ Modalit√† di Pulizia"
      description: |
        Scegli la modalit√† di pulizia desiderata:
        
        üßπ **Aspirazione**: Solo aspirazione (CleanGenius OFF)
        üíß **Lavaggio**: Solo lavaggio (CleanGenius OFF)  
        ‚ú® **Pulizia**: Aspirazione + Lavaggio simultanei
        üî• **Pulizia Profonda**: Aspirazione + Lavaggio intensivo
      selector:
        select:
          options:
            - label: "üßπ Aspirazione"
              value: "Aspirazione"
            - label: "üíß Lavaggio" 
              value: "Lavaggio"
            - label: "‚ú® Pulizia"
              value: "Pulizia"
            - label: "üî• Pulizia Profonda"
              value: "Pulizia profonda"
      default: "Pulizia"

icon: mdi:robot-vacuum

mode: single

sequence:
  - variables:
      _vac: !input vacuum_entity
      _cg_sel: !input cleangenius_select
      _cm_sel: !input cleaning_mode_select
      _rid: !input room_id
      _preset_raw: !input cleaning_preset
      preset: "{{ (_preset_raw or 'Pulizia') | lower }}"

  # Validazione ID stanza
  - condition: template
    value_template: "{{ (_rid | int(default=-1)) >= 0 }}"
    alias: "Verifica validit√† ID stanza"

  # Branch in base al preset
  - choose:
      # PULIZIA PROFONDA ‚Üí CleanGenius deep_cleaning
      - conditions:
          - condition: template
            value_template: "{{ preset == 'pulizia profonda' }}"
        sequence:
          - alias: "Imposta CleanGenius Deep Cleaning"
            service: select.select_option
            target:
              entity_id: "{{ _cg_sel }}"
            data:
              option: deep_cleaning

          - alias: "Attendi cambio modalit√† CleanGenius"
            wait_template: >-
              {{ states(_cg_sel) in ['deep_cleaning','unknown','unavailable','none'] }}
            timeout: "00:00:10"

          - alias: "Avvia pulizia profonda stanza"
            service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ _vac }}"
            data:
              segments:
                - "{{ _rid | int }}"

      # PULIZIA (standard) ‚Üí CleanGenius lasciato com'√® (nessun cambio), poi avvio
      - conditions:
          - condition: template
            value_template: "{{ preset == 'pulizia' }}"
        sequence:
          - alias: "Avvia pulizia standard stanza"
            service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ _vac }}"
            data:
              segments:
                - "{{ _rid | int }}"

      # ASPIRAZIONE ‚Üí CleanGenius OFF ‚Üí cleaning_mode sweeping ‚Üí avvio
      - conditions:
          - condition: template
            value_template: "{{ preset == 'aspirazione' }}"
        sequence:
          - alias: "Disattiva CleanGenius"
            service: select.select_option
            target:
              entity_id: "{{ _cg_sel }}"
            data:
              option: 'off'

          - alias: "Attendi disattivazione CleanGenius"
            wait_template: >-
              {{ states(_cg_sel) in ['off','unknown','unavailable','none'] }}
            timeout: "00:00:10"

          - alias: "Imposta modalit√† aspirazione"
            service: select.select_option
            target:
              entity_id: "{{ _cm_sel }}"
            data:
              option: sweeping

          - delay: "00:00:01"

          - alias: "Avvia aspirazione stanza"
            service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ _vac }}"
            data:
              segments:
                - "{{ _rid | int }}"

      # LAVAGGIO ‚Üí CleanGenius OFF ‚Üí cleaning_mode mopping ‚Üí avvio
      - conditions:
          - condition: template
            value_template: "{{ preset == 'lavaggio' }}"
        sequence:
          - alias: "Disattiva CleanGenius"
            service: select.select_option
            target:
              entity_id: "{{ _cg_sel }}"
            data:
              option: 'off'

          - alias: "Attendi disattivazione CleanGenius"
            wait_template: >-
              {{ states(_cg_sel) in ['off','unknown','unavailable','none'] }}
            timeout: "00:00:10"

          - alias: "Imposta modalit√† lavaggio"
            service: select.select_option
            target:
              entity_id: "{{ _cm_sel }}"
            data:
              option: mopping

          - delay: "00:00:01"

          - alias: "Avvia lavaggio stanza"
            service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ _vac }}"
            data:
              segments:
                - "{{ _rid | int }}"

    default: []